---
title: "ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ API ã¨ MediaStream åéŒ² API ã‚’ä½¿ã£ã¦ã¿ãŸ"
publishedAt: "2023-02-03"
summary: "ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸã‚Šã€ãã‚Œã‚’åéŒ²ã§ãã‚‹é¢ç™½ãã†ãª API ã‚’è¦‹ã¤ã‘ãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚"
---

<div role="alert" className="alert alert-info alert-soft">
  ã“ã®è¨˜äº‹ã¯ https://qiita.com/nymphaea/items/7e41c54703bb61fad72a
  ã‹ã‚‰ç§»æ¤ã—ã¾ã—ãŸã€‚
</div>

ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸã‚Šã€ãã‚Œã‚’åéŒ²ã§ãã‚‹é¢ç™½ãã†ãª API ã‚’è¦‹ã¤ã‘ãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

https://developer.mozilla.org/ja/docs/Web/API/Screen_Capture_API

https://developer.mozilla.org/ja/docs/Web/API/MediaStream_Recording_API

## ä½œã£ãŸã‚‚ã®

<img
  width="500"
  src="/images/blog/advent-calendar-2022/screen-recorder-demo.gif"
  alt="æç«œã‚²ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã„ã‚‹æ§˜å­"
/>

[æç«œã‚²ãƒ¼ãƒ ](chrome://dino)ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã„ã‚‹æ§˜å­ã§ã™ã€‚ğŸ¦–
GitHub Pages ã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://mikrogeophagus.github.io/screen-recorder

https://github.com/mikrogeophagus/screen-recorder

## Screen Capture API ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹

https://developer.mozilla.org/ja/docs/Web/API/Screen_Capture_API

### ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹ã™ã‚‹

[`MediaDevices.getDisplayMedia()`](https://developer.mozilla.org/ja/docs/Web/API/MediaDevices/getDisplayMedia) ã‚’ä½¿ã£ã¦ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ãã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸã„ã‚¿ãƒ–ã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é¸æŠã™ã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img
  width="500"
  src="/images/blog/advent-calendar-2022/capture-popup.png"
  alt="ã‚­ãƒ£ãƒ—ãƒãƒ£å¯¾è±¡é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—"
/>

<div role="alert" className="alert alert-warning alert-soft">
  ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ããªã„ã¨ãã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ç”»é¢åéŒ²ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚
  https://support.apple.com/ja-jp/guide/mac-help/mchld6aa7d23/mac
</div>

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã§ã¯ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹å‹•ç”»ã‚„éŸ³å£°ãªã©ã®è©³ç´°ãªè¨­å®šãŒã§ãã¾ã™ã€‚
https://www.w3.org/TR/screen-capture/#constrainable-properties

```js
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    // è§£åƒåº¦
    width: 1920,
    height: 1080,

    // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ
    frameRate: 60,
  },

  // éŸ³å£°ãªã—
  audio: false,
})
```

æˆ»ã‚Šå€¤ã¨ã—ã¦ [`MediaStream`](https://developer.mozilla.org/ja/docs/Web/API/MediaStream) ã§è§£æ±ºã™ã‚‹ `Promise` ã‚’è¿”ã—ã¾ã™ã€‚
`MediaStream` ã¯ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå‹•ç”»ã‚„éŸ³å£°ã®ãƒˆãƒ©ãƒƒã‚¯ ([`MediaStreamTrack`](https://developer.mozilla.org/ja/docs/Web/API/MediaStreamTrack)) ã‚’å«ã‚“ã ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ã“ã® `MediaStream` ã¯ã€ãã®ã¾ã¾ [`HTMLMediaElement.srcObject`](https://developer.mozilla.org/ja/docs/Web/API/HTMLMediaElement/srcObject) ã«è¨­å®šã—ã¦ `<video>` ã§å†ç”Ÿã—ãŸã‚Šã€å¾Œè¿°ã® MediaStream Recording API ã‚’ä½¿ã£ã¦åéŒ²ã—ãŸã‚Šã€ãªã©ãªã©ã§ãã¾ã™ã€‚

### ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’çµ‚äº†ã™ã‚‹

ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã™ã¹ã¦ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢ã—ã¾ã™ã€‚

1. [`MediaStream.getTracks()`](https://developer.mozilla.org/ja/docs/Web/API/MediaStream/getTracks) ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã™ã¹ã¦ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚
2. [`MediaStreamTrack.stop()`](https://developer.mozilla.org/ja/docs/Web/API/MediaStreamTrack/stop) ã§ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢ã—ã¾ã™ã€‚

```js
const tracks = stream.getTracks()

tracks.forEach((track) => {
  track.stop()
})
```

<div role="alert" className="alert alert-info alert-soft">
`MediaStreamTrack` ã® [`ended`](https://developer.mozilla.org/ja/docs/Web/API/MediaStreamTrack/ended_event) ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œå…±æœ‰ã‚’åœæ­¢ã€ã‚’æŠ¼ã—ãŸã‚Šã€ã‚¿ãƒ–ã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ãŸã‚Šã—ã¦ç”»é¢å…±æœ‰ãŒåœæ­¢ã•ã‚ŒãŸã“ã¨ã‚’æ¤œçŸ¥ã§ãã¾ã™ã€‚
`MediaStreamTrack.stop()` ã§ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢ã—ãŸå ´åˆã¯ `ended` ã‚¤ãƒ™ãƒ³ãƒˆã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚

![å…±æœ‰åœæ­¢ãƒœã‚¿ãƒ³](/images/blog/advent-calendar-2022/stop-sharing.png)

```js
const [track] = stream.getTracks()

track.addEventListener("ended", () => {
  console.log("ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚")
})
```

</div>

## MediaStream Recording API ã§åéŒ²ã™ã‚‹

https://developer.mozilla.org/ja/docs/Web/API/MediaStream_Recording_API

#### ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹

ã¾ãš [`MediaStream`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder) ã‚’åéŒ²ã™ã‚‹ãŸã‚ã® `MediaRecorder` ã‚’ä½œæˆã—ã¾ã™ã€‚

[`MediaRecorder()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/MediaRecorder) ã®ç¬¬ 1 å¼•æ•°ã«ã¯ã€åéŒ²ã—ãŸã„ `MediaStream` ã‚’æ¸¡ã—ã¾ã™ã€‚
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç¬¬ 2 å¼•æ•°ã§ã¯ã€MIME ã‚¿ã‚¤ãƒ—ã‚„ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã®è¨­å®šãŒã§ãã¾ã™ã€‚

```js
const recorder = new MediaRecorder(stream, { mimeType: "video/webm" })
```

#### åéŒ²ã‚’é–‹å§‹ã™ã‚‹

[`MediaRecorder.start()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/start) ã§åéŒ²ã‚’é–‹å§‹ã—ã¾ã™ã€‚
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã«ã¯ã€ä¸€åº¦ã«åéŒ²ã™ã‚‹é•·ã•ã‚’ãƒŸãƒªç§’ã§æŒ‡å®šã§ãã¾ã™ã€‚
ä¾‹ãˆã° `start(1000)` ã¨æŒ‡å®šã—ãŸå ´åˆã¯ 1 ç§’ã”ã¨ã«åˆ†å‰²ã—ã¦åéŒ²ã§ãã¾ã™ã€‚

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `start` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã¾ãŸã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã‚’æ¸¡ã—ãŸå ´åˆã¯ã€æŒ‡å®šã—ãŸãƒŸãƒªç§’ã”ã¨ã« `dataavailable` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js
// 1000 ãƒŸãƒªç§’ã”ã¨ã« Blob ã«åéŒ²ã™ã‚‹
recorder.start(1000)
```

#### åéŒ²ã‚’åœæ­¢ã™ã‚‹

[`MediaRecorder.stop()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/stop) ã§åéŒ²ã‚’åœæ­¢ã—ã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `stop` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js
recorder.stop()
```

ã¾ãŸã€åéŒ²ä¸­ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰ãŒçµ‚äº†ã—ãŸå ´åˆã¯ã€è‡ªå‹•çš„ã«åéŒ²ãŒåœæ­¢ã•ã‚Œã¾ã™ã€‚

#### åéŒ²ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹

[`MediaRecorder.pause()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/pause) ã§åéŒ²ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `pause` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js
recorder.pause()
```

#### åéŒ²ã‚’å†é–‹ã™ã‚‹

[`MediaRecorder.resume()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/resume) ã§åéŒ²ã‚’å†é–‹ã—ã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `pause` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js
recorder.pause()
```

#### åéŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹

`dataavailable` ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å¼•æ•°ã«ã¯ `BlobEvent` ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
ã“ã® [`BlobEvent.data`](`https://developer.mozilla.org/ja/docs/Web/API/BlobEvent/data`) ã«åéŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ `Blob` ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

```js
recorder.addEventListener("dataavailable", (event) => {
  const blob = event.data
})
```

- `MediaRecorder.start()` ã«å¼•æ•°ã‚’æŒ‡å®šã—ãªã„å ´åˆã¯ã€`dataavailable` ã‚¤ãƒ™ãƒ³ãƒˆã¯åéŒ²åœæ­¢æ™‚ã« 1 åº¦ã ã‘ç™ºç”Ÿã—ã¾ã™ã€‚
- `MediaRecorder.start()` ã«å¼•æ•°ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã€`dataavailable` ã‚¤ãƒ™ãƒ³ãƒˆã¯æŒ‡å®šã—ãŸãƒŸãƒªæ•°ã”ã¨ã«ç™ºç”Ÿã—ã¾ã™ã€‚

<div role="alert" className="alert alert-info alert-soft">
[`MediaRecorder.requestData()`](https://developer.mozilla.org/ja/docs/Web/API/MediaRecorder/requestData) ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€åéŒ²ä¸­ã¾ãŸã¯ä¸€æ™‚åœæ­¢ä¸­ã®ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ `dataavailable` ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚‚åéŒ²ã¯åœæ­¢ã•ã‚Œã¾ã›ã‚“ãŒã€ã“ã‚Œä»¥é™ã«åéŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯æ–°ã—ã„ `Blob` ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

```js
recorder.requestData()
```

</div>

---

```js
;(async () => {
  // åéŒ²ã•ã‚ŒãŸç´°åˆ‡ã‚Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ã¤ã‚ã‚‹
  let chunks = []

  // å‹•ç”»ã¨éŸ³å£°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹
  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: true,
    audio: true,
  })

  // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸå‹•ç”»ã¨éŸ³å£°ã‚’ã€€WebM å½¢å¼ã§åéŒ²ã™ã‚‹
  const recorder = new MediaRecorder(stream, { mimeType: "video/webm" })

  // åéŒ²ã‚’é–‹å§‹ã™ã‚‹
  recorder.start(1000)

  // 10 ç§’å¾Œã«åéŒ²ã‚’åœæ­¢ã™ã‚‹
  setTimeout(() => recorder.stop(), 10000)

  // start() ã«æŒ‡å®šã—ãŸ 1 ç§’ã”ã¨ã« dataavailable ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹
  recorder.addEventListener("dataavailable", (event) => {
    // åéŒ²ã•ã‚ŒãŸç´°åˆ‡ã‚Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ã¤ã‚ã‚‹
    chunks.push(event.data)
  })

  // åéŒ²åœæ­¢æ™‚ã« stop ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹
  recorder.addEventListener("stop", () => {
    // Blob ã®é…åˆ—ã‹ã‚‰ 1 ã¤ã® File ã‚’ä½œã‚‹
    // ã“ã‚Œã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãŸã‚Šã—ã¦ä½¿ãˆã¾ã™
    const file = new File(chunks, "screen-recording.webm", {
      type: "video/webm",
    })
    console.log(file)
  })
})()
```

## é–¢é€£ã—ã¦ã„ã‚‹ API / çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã¨é¢ç™½ãã†ãª API

### MediaDevices.getUserMedia()

ã“ã¡ã‚‰ã¯ã‚«ãƒ¡ãƒ©ã‚„ãƒã‚¤ã‚¯ã‹ã‚‰ã®å…¥åŠ›ã‚’ `MediaStream` ã¨ã—ã¦å–å¾—ã§ãã¾ã™ã€‚
`MediaDevices.getDisplayMedia()` ã¨ä½¿ã„æ–¹ã‚‚ä¼¼ã¦ã„ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/MediaDevices/getUserMedia

### HTMLCanvasElement.captureStream()

`<canvas>` ã®æç”»å†…å®¹ã‚’ `MediaStream` ã¨ã—ã¦å–å¾—ã§ãã¾ã™ã€‚
WebSocket ãªã©ã¨çµ„ã¿åˆã‚ã›ã¦[ãŠãˆã‹ãã®æ£®](https://oekaki.hange.jp/)ã¿ãŸã„ãªã‚¢ãƒ—ãƒªã‚‚ä½œã‚Œãã†ã§ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/HTMLCanvasElement/captureStream

### WebRTC API

å‹•ç”»ã‚„éŸ³å£°ã€ãƒ†ã‚­ã‚¹ãƒˆãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’ P2P ã§é€å—ä¿¡ã§ãã¾ã™ã€‚
`MediaStream` ã‚’ä½¿ã£ã¦ç›¸æ‰‹ã«ç”»é¢ã‚’å…±æœ‰ã—ãŸã‚Šã€ãƒ“ãƒ‡ã‚ªé€šè©±ã—ãŸã‚Šã§ãã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/WebRTC_API

### IndexedDB API

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã® Key-Value ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚
å¤§å®¹é‡ã§ã•ã¾ã–ã¾ãªå‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

åéŒ²ã—ãŸå‹•ç”»ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¦ãŠããŸã„ã¨ããªã©ã«ä½¿ãˆã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/IndexedDB_API
